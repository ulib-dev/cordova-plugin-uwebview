<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
  </head>
  <body style="background-color: black; margin: 0">
    <video
      id="player"
      style="
        background-color: black;
        width: 100%;
        height: 100vh;
        object-fit: cover;
      "
      autoplay
      muted
      controls
    >
      <source src="UVIEW{@##@}UVIEW" type="video/mp4" />
    </video>

    <script>
      "use strict";

      function mySendMessageToApp() {
        try {
          sendMessageToApp(message);
        } catch (error) {
          console.error(error);
        }
      }

      // 初始化 Plyr 播放器
      const player = new Plyr("#player", {
        controls: [
          "play-large", // 大的播放按钮
          "play", // 播放/暂停按钮
          "progress", // 进度条
          "current-time", // 当前时间
          "mute", // 静音按钮
          "volume", // 音量控制
          "settings", // 设置按钮
          "fullscreen", // 全屏按钮
          "custom-screenshot", // 自定义按钮
        ],
      });

      // 监听播放事件
      player.on("play", function () {
        console.log("Video is playing");
        mySendMessageToApp({ event: "onPlay" });
      });

      // 监听暂停事件
      player.on("pause", function () {
        console.log("Video is paused");
        mySendMessageToApp({ event: "onPause" });
      });

      // 监听音量变化事件
      player.on("volumechange", function () {
        console.log("Volume changed");
        mySendMessageToApp({
          event: "volumechange",
          muted: player.muted,
          volume: player.volume,
        });
      });

      // 监听视频播放结束事件，重置到开始
      player.on("ended", function () {
 
        player.currentTime = 0; // 将播放时间重置为 0
        player.pause();         // 暂停播放（以防自动播放）
      });

      // 监听全屏切换事件
      player.on("enterfullscreen", function () {
        console.log("Entered full screen");
        mySendMessageToApp({
          event: "fullscreenchange",
          message: "Entered full screen",
        });
      });

      player.on("exitfullscreen", function () {
        console.log("Exited full screen");
        mySendMessageToApp({
          event: "fullscreenchange",
          message: "Exited full screen",
        });
      });

      // 控制按钮功能
      function play() {
        player.play();
        mySendMessageToApp({
          event: "play_button",
          message: "Play button clicked",
        });
      }

      function pause() {
        player.pause();
        mySendMessageToApp({
          event: "pause_button",
          message: "Pause button clicked",
        });
      }

      function toggleMute() {
        player.muted = !player.muted;
        mySendMessageToApp({
          event: "mute_button",
          message: "Mute button clicked",
          muted: player.muted,
        });
      }

      function enterFullScreen() {
        player.fullscreen.enter();
        mySendMessageToApp({
          event: "fullscreen_button",
          message: "Fullscreen button clicked",
        });
      }

      function exitFullScreen() {
        player.fullscreen.exit();
        mySendMessageToApp({
          event: "exit_fullscreen_button",
          message: "Exit fullscreen button clicked",
        });
      }
      // 截图功能：使用 Canvas 对视频进行截图
      function captureScreenshot() {
        const video = document.querySelector("#player");
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const dataURL = canvas.toDataURL("image/png");

        mySendMessageToApp({
          event: "captureScreenshot",
          message: "Exit fullscreen button clicked",
          dataURL: dataURL,
        });

        // // 将截图显示在页面上
        // const screenshotImg = document.getElementById('screenshot');
        // screenshotImg.src = dataURL;
        // screenshotImg.style.display = 'block';

        // 如果你需要将图片下载到本地，可以使用下面的代码
        // const link = document.createElement('a');
        // link.href = dataURL;
        // link.download = 'screenshot.png';
        // link.click();
      }
      // 创建自定义按钮并添加到播放器控件中
      function createCustomButton() {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "plyr__controls__item plyr__control"; // Plyr 控件样式

        // 使用 Font Awesome 的截图图标
        button.innerHTML = '<i class="fas fa-camera"></i>'; // 截图图标

        // 当按钮点击时，执行截图功能
        button.addEventListener("click", captureScreenshot);

        return button;
      }

      // 将自定义按钮添加到 Plyr 控件中
      player.on("ready", function () {
        const controls = player.elements.controls;
        const customButton = createCustomButton();
        // 将按钮插入到现有控件中
        controls.appendChild(customButton);
      });
    </script>
  </body>
</html>
